---
layout:     post
title:      消息队列设计
subtitle:   
date:       2017-06-19
author:     BY
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - MQ
---



本文是对美团的《[消息队列设计精要](https://tech.meituan.com/2016/07/01/mq-design.html)》一文的总结，并认可文中的rpc消息队列的设计思想，对原作者的分享表示感谢。我在这里将总结分享给大家，也希望和大家一起讨论消息队列的技术细节！

## 最简单的消息队列是一个消息转发器和两次RPC：
1. producer发送消息给broker的RPC
2. consumer消费确认的RPC
3. broker将消息落地后再转发到接受者

把这三个环节解决了，消息队列就可以实现了。

## 需要解决的技术要点：

**1.producer向broker的可靠消息投递**

producer发送消息之前先在本地落地，broker收到消息之后也要先落地，之后再告诉producer发送成功，producer再删除本地消息。如果没有收到发送成功或者失败的结果就定时重发（重发次数要做限制），保证消息一定送达。

**2.broker持久化收到的消息**

broker收到消息后先持久化，这个持久化可以是文件系统，分布式kv或数据库。broker收到消费确认之后再从持久化存储中移除消息，这里的移除是逻辑上的移除，不是真正的移除，便于消息回溯。持久化消息也便于做消息队列的重启恢复。

**3.消费确认**

把消息的送达和消息的处理分开，简单说需要消费者两次确认，一次送达，一次处理完成。

消费者主动ACK处理结果，如果需要重发还可以约定重发的时间。

**4.重复消息的处理**

主要是鉴别重复消息和减少重复投递

broker记录message id, 直到消息被消费后后清除，重复id到来不处理；

broker投递到consumer的消息在需要重发之前询问consumer消息处理完了吗，如果询问无果再重发

**5.幂等性**

由于有重复消息，所以要解决幂等性的问题。一个简单的方法是共享存储，broker多机器共享一个DB或者一个分布式文件/kv系统，则处理消息自然是幂等的。

**6.高可用**

主备或者raft保证高可用


# 提升IO性能的手段
- 使用批量处理的方式提升系统吞吐量
- 顺序读写代替随机读写
- 利用缓存减少IO
- 使用零拷贝技术加速消费流程

# 参考

- [RPC消息队列的技术思想 ](http://purecpp.org/detail?id=2155)
- [消息队列设计精要](https://tech.meituan.com/2016/07/01/mq-design.html)
